name: Prerender & Deploy

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build
        env:
          DISABLE_ESLINT_PLUGIN: true
          TSC_COMPILE_ON_ERROR: true
          REACT_APP_YOUTUBE_API_KEY: ${{ secrets.REACT_APP_YOUTUBE_API_KEY }}
          REACT_APP_YOUTUBE_API_KEY_2: ${{ secrets.REACT_APP_YOUTUBE_API_KEY_2 }}
          REACT_APP_YOUTUBE_API_KEY_3: ${{ secrets.REACT_APP_YOUTUBE_API_KEY_3 }}
          REACT_APP_YOUTUBE_API_KEY_4: ${{ secrets.REACT_APP_YOUTUBE_API_KEY_4 }}
          REACT_APP_YOUTUBE_API_KEY_5: ${{ secrets.REACT_APP_YOUTUBE_API_KEY_5 }}
          REACT_APP_YOUTUBE_API_KEY_6: ${{ secrets.REACT_APP_YOUTUBE_API_KEY_6 }}
          REACT_APP_YOUTUBE_API_KEY_7: ${{ secrets.REACT_APP_YOUTUBE_API_KEY_7 }}
          REACT_APP_YOUTUBE_API_KEY_8: ${{ secrets.REACT_APP_YOUTUBE_API_KEY_8 }}
          REACT_APP_YOUTUBE_API_KEY_9: ${{ secrets.REACT_APP_YOUTUBE_API_KEY_9 }}
          REACT_APP_YOUTUBE_API_KEY_10: ${{ secrets.REACT_APP_YOUTUBE_API_KEY_10 }}
        run: npm run build

      - name: Copy sitemap
        run: cp public/sitemap.xml build/

      - name: Install Chromium system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libxkbcommon0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libgbm1 \
            libasound2t64

      - name: Prerender with react-snap
        run: node prerender.js

      - name: Structure output for Vercel Build Output API
        run: |
          mkdir -p .vercel/output/static
          cp -r build/. .vercel/output/static/
          echo '{"version":3,"routes":[{"handle":"filesystem"},{"src":"^/(.*)$","dest":"/index.html"}]}' > .vercel/output/config.json

      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          npm install -g vercel
          vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN
